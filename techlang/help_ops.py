from typing import List, Dict
from .core import InterpreterState


HELP_TEXT: Dict[str, str] = {
    "boot": "Reset current value to 0",
    "ping": "Increment current value by 1",
    "crash": "Decrement current value by 1",
    "print": "Print current value, a variable, or a quoted string",
    "set": "set <var> <number> — assign an integer to a variable",
    "add": "add <var> <number|var> — add to a variable",
    "sub": "sub <var> <number|var> — subtract from a variable",
    "mul": "mul <var> <number|var> — multiply a variable",
    "div": "div <var> <number|var> — integer divide (safe error on 0)",
    "loop": "loop <count|var> ... end — repeat a block",
    "while": "while <var> <op> <number|var> ... end — conditional loop",
    "if": "if <var> <op> <number> ... end — conditional block",
    "def": "def <name> [params...] ... end — define a function with optional parameters",
    "call": "call <name> [args...] [return_vars...] — call a function with arguments and capture return values",
    "return": "return [value1] [value2] ... — return values from a function",
    "export": "export <function_name> — mark a function as public (callable from outside modules)",
    "macro": "macro <name> [params...] do ... end — define compile-time macro using $param placeholders",
    "inline": "inline <name> <args...> — expand a macro inline before execution",
    "upload": "Push current value to the stack",
    "download": "Pop value from the stack into current value",
    "debug": "Print stack, variables, arrays/strings/dicts",
    "lag": "lag — pause for 1 second (blocking)",
    "sleep": "sleep <ms> — pause execution for the given milliseconds",
    "yield": "yield — yield control with no delay (scheduler-friendly)",
    "alias": "alias <short> <command> — create shorthand",
    "import": "import <name> — load name.tl once",
    "package": "package use <module> — load a module with namespaced calls (use 'stl' or 'stdlib' for standard template library)",
    "match": "match <expr> ... case [op] <value> ... end — pattern guards with ==, !=, <, <=, >, >=",
    "db_create": "db_create <table> \"cols\" — create table",
    "db_insert": "db_insert <table> \"values\" — insert row",
    "db_select": "db_select \"SQL\" — run SELECT and print rows",
    "db_update": "db_update \"SQL\" — run UPDATE",
    "db_delete": "db_delete \"SQL\" — run DELETE",
    "db_execute": "db_execute \"SQL\" — run any SQL",
    "db_begin": "Begin transaction",
    "db_commit": "Commit current transaction",
    "db_rollback": "Roll back current transaction",
    "db_tables": "List tables",
    "db_schema": "db_schema <table> — show columns",
    "db_indexes": "db_indexes <table> — list indexes",
    "db_connect": "db_connect \"path\" — set current DB",
    "db_disconnect": "Disconnect all DBs",
    "array_create": "array_create <name> <size>",
    "array_set": "array_set <name> <idx> <value|var>",
    "array_get": "array_get <name> <idx>",
    "array_push": "array_push <name> <value|var>",
    "array_pop": "array_pop <name>",
    "array_map": "array_map <source> <target> <op> [value] — transform items (identity, add, mul, negate, double, square, abs)",
    "array_filter": "array_filter <source> <target> <predicate> [value] — keep items (even, odd, positive, negative, nonzero, gt, ge, lt, le, eq, ne, contains)",
    "array_sort": "array_sort <name> [asc|desc] — sort array in place (default: ascending)",
    "array_reverse": "array_reverse <name> — reverse array in place",
    "array_find": "array_find <name> <value> <target> — find index of value (-1 if not found)",
    "array_unique": "array_unique <name> — remove duplicates in place, preserving order",
    "array_join": "array_join <name> <delimiter> <target> — join elements into string",
    "str_create": "str_create <name> \"text\"",
    "str_concat": "str_concat <name> <stringVar|\"text\">",
    "str_length": "str_length <name>",
    "str_substring": "str_substring <name> <start> <end>",
    "str_split": "str_split <string> <delimiter> <array> — split string into array",
    "str_replace": "str_replace <string> <old> <new> — replace all occurrences",
    "str_trim": "str_trim <string> — remove leading/trailing whitespace",
    "str_upper": "str_upper <string> — convert to uppercase",
    "str_lower": "str_lower <string> — convert to lowercase",
    "str_contains": "str_contains <string> <substring> — check if substring exists (prints 1 or 0)",
    "str_reverse": "str_reverse <string> — reverse character order",
    "string_interpolate": "string_interpolate <name> <template> — fill {placeholders} using variables or strings",
    "string_match": "string_match <pattern> <subject> <var> — store 1 if regex matches, else 0",
    "json_parse": "json_parse <source> <target> — parse JSON string into dict/array",
    "json_stringify": "json_stringify <source> <target> — convert dict/array to JSON string",
    "json_read": "json_read \"path\" <target> — read and parse JSON file",
    "json_write": "json_write <source> \"path\" — write dict/array to JSON file",
    "dict_create": "dict_create <name>",
    "dict_set": "dict_set <name> \"key\" \"val\"",
    "dict_get": "dict_get <name> \"key\"",
    "dict_keys": "dict_keys <name> — print sorted keys with counts",
    # Type checking commands
    "type_of": "type_of <name> <target> — get type as string (number, string, array, dict, struct, undefined)",
    "is_number": "is_number <name> <target> — store 1 if numeric variable, else 0",
    "is_string": "is_string <name> <target> — store 1 if string, else 0",
    "is_array": "is_array <name> <target> — store 1 if array, else 0",
    "is_dict": "is_dict <name> <target> — store 1 if dictionary, else 0",
    "is_struct": "is_struct <name> <target> — store 1 if struct instance, else 0",
    # Regex commands
    "regex_match": "regex_match <pattern> <subject> <target> — store 1 if pattern matches, else 0",
    "regex_find": "regex_find <pattern> <subject> <array> — find all matches into array",
    "regex_replace": "regex_replace <pattern> <subject> <replacement> <target> — replace all matches",
    "regex_split": "regex_split <pattern> <subject> <array> — split by pattern into array",
    # Crypto/encoding commands
    "base64_encode": "base64_encode <source> <target> — encode string to base64",
    "base64_decode": "base64_decode <source> <target> — decode base64 string",
    "md5": "md5 <source> <target> — compute MD5 hash",
    "sha256": "sha256 <source> <target> — compute SHA256 hash",
    "sha512": "sha512 <source> <target> — compute SHA512 hash",
    "uuid": "uuid <target> — generate random UUID",
    "hex_encode": "hex_encode <source> <target> — encode string to hexadecimal",
    "hex_decode": "hex_decode <source> <target> — decode hexadecimal string",
    # Assert command
    "assert": "assert <var> <op> <value> [message] — fail with error if condition is false (ops: ==, !=, <, <=, >, >=)",
    # Bitwise operations
    "bit_and": "bit_and <a> <b> <target> — bitwise AND (a & b)",
    "bit_or": "bit_or <a> <b> <target> — bitwise OR (a | b)",
    "bit_xor": "bit_xor <a> <b> <target> — bitwise XOR (a ^ b)",
    "bit_not": "bit_not <a> <target> — bitwise NOT (~a)",
    "bit_shift_left": "bit_shift_left <val> <n> <target> — left shift (val << n)",
    "bit_shift_right": "bit_shift_right <val> <n> <target> — right shift (val >> n)",
    "struct": "struct <Type> <fields...> end / struct new|set|get|dump — manage records",
    "file_read": "file_read \"path\" <var>",
    "file_write": "file_write \"path\" \"text\" [okVar] — write text to file; if okVar provided, store 1/0 and emit no output",
    "file_append": "file_append \"path\" \"text\" [okVar] — append text to file; if okVar provided, store 1/0 and emit no output",
    "file_exists": "file_exists \"path\" [outVar] — if outVar provided, store 1/0; otherwise output true/false",
    "file_delete": "file_delete \"path\" [okVar] — delete file; if okVar provided, store 1/0 and emit no output",
    "file_list": "file_list \"dir\" [outArr] [okVar] — if outArr provided, store entries into array (and okVar=1/0); otherwise output one entry per line",
    "path_join": "path_join <a> <b> <targetStr> — join two path segments into targetStr (no output)",
    "path_basename": "path_basename <path> <targetStr> — store basename into targetStr (no output)",
    "path_dirname": "path_dirname <path> <targetStr> — store dirname into targetStr (no output)",
    "path_extname": "path_extname <path> <targetStr> — store file extension (including dot) into targetStr (no output)",
    "http_get": "http_get \"url\" <respVar> — store body/status",
    "http_post": "http_post \"url\" <dataToken> — store response",
    "http_status": "http_status <respVar> — print saved status",
    "server_start": "server_start <port> — stub",
    "server_route": "server_route \"/path\" <handler> — stub",
    "server_stop": "Stop server (stub)",
    "graphics_init": "graphics_init <w> <h> — prepare canvas",
    "graphics_draw_line": "graphics_draw_line x1 y1 x2 y2",
    "graphics_draw_circle": "graphics_draw_circle x y r",
    "graphics_draw_text": "graphics_draw_text x y \"text\"",
    "graphics_show": "Save canvas to techlang_canvas.png",
    "math_sin": "math_sin <deg>",
    "math_cos": "math_cos <deg>",
    "math_tan": "math_tan <deg>",
    "math_asin": "math_asin <value [-1..1]> — returns degrees",
    "math_acos": "math_acos <value [-1..1]> — returns degrees",
    "math_atan": "math_atan <value> — returns degrees",
    "math_sqrt": "math_sqrt <n>",
    "math_pow": "math_pow <b> <e>",
    "math_random": "math_random <lo> <hi> [targetVar] — if targetVar provided, store result (no output)",
    "math_seed": "math_seed <n> — seed random number generator (deterministic)",
    "math_round": "math_round <value> — nearest integer",
    "math_floor": "math_floor <value> — floor as integer",
    "math_ceil": "math_ceil <value> — ceil as integer",
    "math_deg2rad": "math_deg2rad <deg> — convert to radians",
    "math_rad2deg": "math_rad2deg <rad> — convert to degrees",
    "math_pi": "Print π",
    "math_e": "Print e",
    "now": "now [targetStr] — current UTC timestamp (ISO 8601); if targetStr provided, store into string (no output)",
    "format_date": 'format_date <seconds> ["fmt"|fmtStrVar] [targetStr] — format unix timestamp (UTC); if targetStr provided, store into string (no output)',
    "mem_alloc": "mem_alloc <size> — allocate integer cells (returns base address)",
    "mem_free": "mem_free <addr>",
    "mem_read": "mem_read <addr>",
    "mem_write": "mem_write <addr> <value>",
    "mem_dump": "Print memory contents",
    "try": "try ... catch [errVar [stackVar]] ... end — run catch if [Error:] is emitted",
    "thread_create": "thread_create <fn> — run function in a background interpreter",
    "thread_join": "thread_join <id> — wait for thread output",
    "thread_sleep": "thread_sleep <ms> — pause execution",
    "thread_status": "thread_status <id> — report if a thread is running or finished",
    "thread_result": "thread_result <id> — fetch cached thread output without joining",
    "thread_list": "thread_list — list currently tracked thread ids",
    "thread_wait_all": "thread_wait_all — join every active thread and emit their outputs",
    "async_start": "async_start <fn> — alias for thread_create",
    "async_wait": "async_wait <id> — alias for thread_join",
    "mutex_create": "mutex_create <name> — create a named mutex",
    "mutex_lock": "mutex_lock <name> — acquire a mutex (30s timeout)",
    "mutex_unlock": "mutex_unlock <name> — release a mutex",
    "queue_push": "queue_push <queue> <value> — enqueue resolved value (auto-creates queue)",
    "queue_pop": "queue_pop <queue> <var> — dequeue into string/variable (waits up to 30s)",
    "sys_exec": "sys_exec \"cmd\" — run command",
    "sys_env": "sys_env <VAR> — print environment variable",
    "sys_time": "sys_time [targetVar] — unix timestamp; if targetVar provided, store into variable (no output)",
    "sys_date": "sys_date — ISO timestamp",
    "sys_sleep": "sys_sleep <ms> — sleep for the given milliseconds",
    "sys_cwd": "sys_cwd — print current working directory",
    "sys_exit": "sys_exit [code] — store exit code in _exit",
    "proc_spawn": "proc_spawn \"cmd\" — start subprocess (returns id)",
    "proc_kill": "proc_kill <id> — terminate subprocess",
    "proc_wait": "proc_wait <id> [timeout] — wait, stream output lines, update arrays",
    "proc_status": "proc_status <id> — report running state or exit code",
    # GUI (tkinter/customtkinter)
    "gui_backend": "gui_backend <tk|ctk> — choose GUI backend (tkinter or customtkinter)",
    "gui_ctk_appearance": "gui_ctk_appearance <light|dark|system> — set CustomTkinter appearance mode (spec-first)",
    "gui_ctk_theme": 'gui_ctk_theme <"name"|pathVar> — set CustomTkinter default theme (name or .json path; spec-first)',
    "gui_ctk_scaling": "gui_ctk_scaling <percent> — set CustomTkinter widget scaling percent (e.g., 100, 125; spec-first)",
        "gui_ctk_switch": 'gui_ctk_switch <name> <parent> "text" [var] — Create a CTkSwitch (ctk backend at runtime).',
        "gui_ctk_slider": "gui_ctk_slider <name> <parent> [var] — Create a CTkSlider (ctk backend at runtime).",
        "gui_ctk_progressbar": "gui_ctk_progressbar <name> <parent> [var] — Create a CTkProgressBar (ctk backend at runtime).",
        "gui_ctk_progress_set": "gui_ctk_progress_set <progressbar> <value> — Set a CTkProgressBar value (0..1 typical).",
        "gui_ctk_optionmenu": "gui_ctk_optionmenu <name> <parent> <values> [var] — Create a CTkOptionMenu. <values> can be an array name or \"a,b,c\".",
        "gui_ctk_combobox": "gui_ctk_combobox <name> <parent> <values> [var] — Create a CTkComboBox. <values> can be an array name or \"a,b,c\".",
        "gui_ctk_tabview": "gui_ctk_tabview <name> <parent> — Create a CTkTabview (ctk backend at runtime).",
        "gui_ctk_tab": 'gui_ctk_tab <name> <tabview> "label" — Add/get a tab frame from a CTkTabview; use <name> as parent for child widgets.',
    "gui_window": 'gui_window <name> "title" <width> <height> — define a window',
    "gui_label": 'gui_label <name> <parent> "text" — add a label (auto-packed)',
    "gui_button": 'gui_button <name> <parent> "text" [fn] — add a button; optional fn is a TechLang function name to call on click',
    "gui_entry": "gui_entry <name> <parent> — add a text entry (auto-packed)",
    "gui_entry_get": "gui_entry_get <entry> <target> [str|var] — copy entry text into a string (default) or variable",
    "gui_entry_set": 'gui_entry_set <entry> <"text"|stringVar> — set entry text',
    "gui_destroy": "gui_destroy <name> — remove a GUI object from the spec",
    "gui_mainloop": "gui_mainloop <window> — build the window and start the UI event loop (blocking)",
    "gui_set": 'gui_set <widget> "option" <value> — set a widget option (stored in spec; applied at runtime if active)',
    "gui_get": 'gui_get <widget> "option" <target> [str|var] — read an option into a string/variable',
    "gui_pack": "gui_pack <widget> [key value]... — store/apply pack layout options",
    "gui_grid": "gui_grid <widget> [key value]... — store/apply grid layout options",
    "gui_bind": 'gui_bind <widget> "<Event>" <fn> — bind event to TechLang function (spec + runtime when active)',
    "gui_frame": "gui_frame <name> <parent> — add a frame container",
    "gui_checkbutton": 'gui_checkbutton <name> <parent> "text" [var] — add a checkbox (optional gui_var name)',
    "gui_radiobutton": 'gui_radiobutton <name> <parent> "text" <var> <value> — add a radio button bound to gui_var',
    "gui_text": "gui_text <name> <parent> — add a multiline text widget",
    "gui_listbox": "gui_listbox <name> <parent> — add a listbox",
    "gui_canvas": "gui_canvas <name> <parent> — add a canvas",
    "gui_scrollbar": "gui_scrollbar <name> <parent> [vertical|horizontal] — add a scrollbar",
    "gui_canvas_create_line": "gui_canvas_create_line <canvas> x1 y1 x2 y2 — add a line item to a canvas spec",
    "gui_canvas_move": "gui_canvas_move <canvas> <id> dx dy — move an item in a canvas spec",
    "gui_canvas_delete": "gui_canvas_delete <canvas> <id|all> — delete an item (or all) from a canvas spec",
    "gui_canvas_coords": "gui_canvas_coords <canvas> <id> <target> [str|var] — store an item's coords string",
    "gui_text_insert": "gui_text_insert <text> <pos> \"text\" — insert content (spec-first; start/end only)",
    "gui_text_get": "gui_text_get <text> <target> [str|var] — get content from runtime if active, else spec",
    "gui_text_delete": "gui_text_delete <text> all — clear text content",
    "gui_text_tag_add": "gui_text_tag_add <text> <tag> <start> <end> — add a tag range",
    "gui_text_tag_config": "gui_text_tag_config <text> <tag> [key value]... — configure tag options",
    "gui_var_new": "gui_var_new <name> <string|int|bool|double> — define a Tk variable spec",
    "gui_var_set": "gui_var_set <name> <value> — set a Tk variable (spec + runtime when active)",
    "gui_var_get": "gui_var_get <name> <target> [str|var] — read a Tk variable into a string/variable",
    "gui_menubar": "gui_menubar <name> <window> — attach a menubar to a window",
    "gui_menu": 'gui_menu <name> <parent> "label" — create a menu under a menubar or menu',
    "gui_menu_item": 'gui_menu_item <name> <menu> "label" [fn] — add a menu item; optional fn is called on click',
    "gui_messagebox": 'gui_messagebox <type> "title" "message" <target> [str|var] — show a dialog (requires runtime)',
    "gui_filedialog_open": 'gui_filedialog_open "title" <target> [str|var] — open-file dialog (requires runtime)',
    "gui_filedialog_save": 'gui_filedialog_save "title" <target> [str|var] — save-file dialog (requires runtime)',
    "gui_ttk_style_set": 'gui_ttk_style_set <style> "option" <value> — set ttk style option (applied at runtime)',
    "gui_ttk_theme_use": 'gui_ttk_theme_use "theme" — select ttk theme (applied at runtime)',
    "gui_ttk_button": 'gui_ttk_button <name> <parent> "text" [fn] — add a ttk button',
    "gui_ttk_label": 'gui_ttk_label <name> <parent> "text" — add a ttk label',
    "gui_ttk_entry": 'gui_ttk_entry <name> <parent> — add a ttk entry',
    "gui_ttk_combobox": 'gui_ttk_combobox <name> <parent> — add a ttk combobox',
    "gui_ttk_treeview": 'gui_ttk_treeview <name> <parent> — add a ttk treeview',
    "gui_ttk_notebook": 'gui_ttk_notebook <name> <parent> — add a ttk notebook',
    "gui_ttk_notebook_tab": 'gui_ttk_notebook_tab <notebook> <child> "label" — attach a child as a notebook tab',
    "gui_ttk_progressbar": 'gui_ttk_progressbar <name> <parent> — add a ttk progressbar',
    "gui_ttk_separator": 'gui_ttk_separator <name> <parent> — add a ttk separator',
    # Debugger commands
    "breakpoint": "breakpoint — set breakpoint at current command",
    "step": "step — enable step mode (pause after each command)",
    "continue": "continue — resume execution from paused state",
    "inspect": "inspect — show detailed state at current point",
    "watch": "watch <var> — add variable to watch list",
    "unwatch": "unwatch <var> — remove variable from watch list",
    "clear_breakpoints": "clear_breakpoints — remove all breakpoints",
}


class HelpOpsHandler:
    @staticmethod
    def handle_help(state: InterpreterState, tokens: List[str], index: int, known: List[str]) -> int:
        # help or help <command>
        if index + 1 < len(tokens) and tokens[index + 1] not in known:
            # If next token is quoted, ignore — not a command name
            pass
        if index + 1 >= len(tokens):
            # General help
            state.add_output("Commands:")
            for name in sorted(known):
                if name in {"end", "case", "default", "catch"}:
                    continue
                desc = HELP_TEXT.get(name, "")
                state.add_output(f"- {name}{': ' + desc if desc else ''}")
            state.add_output("Use: help <command> for details")
            return 0
        command = tokens[index + 1]
        desc = HELP_TEXT.get(command, None)
        if desc is None:
            state.add_output(f"No help available for '{command}'")
        else:
            state.add_output(f"{command}: {desc}")
        return 1


